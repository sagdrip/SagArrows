(()=>{"use strict";var t={};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var s=t.g.document;if(!e&&s&&(s.currentScript&&"SCRIPT"===s.currentScript.tagName.toUpperCase()&&(e=s.currentScript.src),!e)){var i=s.getElementsByTagName("script");if(i.length)for(var r=i.length-1;r>-1&&(!e||!/^http(s?):/.test(e));)e=i[r--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})();class e{startTime=performance.now();steps=0;value=0;step(){++this.steps}update(){const t=performance.now(),e=t-this.startTime;e>=500&&(this.value=1e3*this.steps/e,this.startTime=t,this.steps=0)}}class s{arrowType=0;medalType=0;rotation=0;flipped=!1;signalCount=0;active=!1;lastState=this;node;offset;originalNode;constructor(t=0,e=0,s=0,i=!1){this.arrowType=t,this.medalType=e,this.rotation=s,this.flipped=i}copy(){return new s(this.arrowType,this.medalType,this.rotation,this.flipped)}copyState(){const t=this.copy();return t.signalCount=this.signalCount,t.active=this.active,t}merge(t){if(0===t.arrowType)throw new Error("Merging with empty arrow");this.arrowType=t.arrowType,this.medalType=t.medalType,this.rotation=t.rotation,this.flipped=t.flipped}}const i=16;class r{hash;adjacentChunks;arrows;constructor(t){this.hash=t,this.adjacentChunks=new Array(8),this.arrows=[];for(let t=0;t<i;++t)for(let t=0;t<i;++t)this.arrows.push(new s)}getArrow(t,e){return this.arrows[e*i+t]}getArrowRelative(t,e){let s=this;return t>=i?e>=i?(s=this.adjacentChunks[3],t-=i,e-=i):e<0?(s=this.adjacentChunks[1],t-=i,e+=i):(s=this.adjacentChunks[2],t-=i):t<0?e<0?(s=this.adjacentChunks[7],t+=i,e+=i):e>=i?(s=this.adjacentChunks[5],t+=i,e-=i):(s=this.adjacentChunks[6],t+=i):e<0?(s=this.adjacentChunks[0],e+=i):e>=i&&(s=this.adjacentChunks[4],e-=i),s?.getArrow(t,e)}isEmpty(){return this.arrows.every((t=>0===t.arrowType))}}function o(t,e){return((0xffffn&BigInt(t))<<16n)+(0xffffn&BigInt(e))}function n(t){let e=Number(t>>16n);32768&e&&(e=-(65535^e)-1);let s=Number(0xffffn&t);return 32768&s&&(s=-(65535^s)-1),[e,s]}function a(t,e){return((0xfffffn&BigInt(t))<<20n)+(0xfffffn&BigInt(e))}function h(t){let e=Number(t>>20n);524288&e&&(e=-(1048575^e)-1);let s=Number(0xfffffn&t);return 524288&s&&(s=-(1048575^s)-1),[e,s]}class l{chunks=new Map;deleteChunk(t){this.chunks.delete(t.hash),t.adjacentChunks.forEach(((t,e)=>{t&&(t.adjacentChunks[(e+4)%8]=void 0)}))}addChunk(t,e,s){this.chunks.set(o(t,e),s);const i=[this.getChunk(t,e-1),this.getChunk(t+1,e-1),this.getChunk(t+1,e),this.getChunk(t+1,e+1),this.getChunk(t,e+1),this.getChunk(t-1,e+1),this.getChunk(t-1,e),this.getChunk(t-1,e-1)];for(let t=0;t<8;++t){const e=i[t];e&&(s.adjacentChunks[t]=e,e.adjacentChunks[(t+4)%8]=s)}}getChunk(t,e){return this.chunks.get(o(t,e))}getOrCreateChunk(t,e){const s=this.getChunk(t,e);if(s)return s;const i=new r(o(t,e));return this.addChunk(t,e,i),i}getChunkForArrow(t,e){const s=+(t<0),i=+(e<0),r=~~((t+s)/16)-s,o=~~((e+i)/16)-i;return this.getChunk(r,o)}getArrow(t,e){const s=+(t<0),r=+(e<0),o=~~((t+s)/16)-s,n=~~((e+r)/16)-r;return t-=o*i,e-=n*i,this.getChunk(o,n)?.getArrow(t,e)}getOrCreateArrow(t,e){const s=+(t<0),r=+(e<0),o=~~((t+s)/16)-s,n=~~((e+r)/16)-r;return t-=o*i,e-=n*i,this.getOrCreateChunk(o,n).getArrow(t,e)}removeArrow(t,e){const s=this.getArrow(t,e);s.arrowType=0,s.rotation=0,s.flipped=!1,s.signalCount=0,s.active=!1,s.lastState=s.copyState();const i=this.getChunkForArrow(t,e);i.isEmpty()&&this.deleteChunk(i)}}class c{array;size;offset=0;constructor(t,e){this.array=new Array(t).fill(e),this.size=t}insert(t){this.offset=(this.offset+this.size-1)%this.size,this.array[this.offset]=t}at(t){return t<0&&(t+=this.size),this.array[(this.offset+t)%this.size]}set(t,e){t<0&&(t+=this.size),this.array[(this.offset+t)%this.size]=e}}class d{arrows;type;targets=[];sources=[];size;signals;signalCount=0;lastSignal=!1;lastSignalCount=0;ready=!1;constructor(t,e,s){this.arrows=t,this.type=e,this.size=s,this.signals=new c(s,!1)}resize(t){this.size=t,this.signals=new c(t,!1)}copy(){return new d([...this.arrows],this.type,this.size)}}const u="SAGA".split("").map((t=>t.charCodeAt(0)));function f(t){const e=[];return e.push(...u),t.chunks.forEach(((t,s)=>{e.push(Number(0xffn&s),Number(s>>8n&0xffn)),e.push(Number(s>>16n&0xffn),Number(s>>24n&0xffn));const r=new Map;for(let e=0;e<i;++e)for(let s=0;s<i;++s){const i=t.getArrow(s,e).arrowType;i>0&&r.set(i,[...r.get(i)??[],[s,e]])}e.push(r.size-1),r.forEach(((s,r)=>{e.push(r-1),e.push(s.length-1);for(const[r,o]of s){const s=t.getArrow(r,o);e.push(o*i+r),e.push(s.medalType),e.push(s.rotation|4*+s.flipped)}}))})),btoa(String.fromCharCode(...e))}function p(t,e){const s=atob(e).split("").map((t=>t.charCodeAt(0)));let n=-1;for(const t of u)if(s[++n]!=t)throw new Error("Invalid magic");const a=s.length-1;for(;n<a;){let e=Number(s[++n]|s[++n]<<8);32768&e&&(e=-(65535^e)-1);let a=Number(s[++n]|s[++n]<<8);32768&a&&(a=-(65535^a)-1);const h=new r(o(a,e)),l=s[++n]+1;for(let t=0;t<l;++t){const t=s[++n]+1,e=s[++n]+1;for(let r=0;r<e;++r){const e=s[++n]%i,r=~~(s[n]/i),o=h.getArrow(e,r);o.arrowType=t,o.medalType=s[++n],o.rotation=3&s[++n],o.flipped=!!(4&s[n])}}t.addChunk(a,e,h)}}class g{arrows;rotatedArrows;medal;rotation;flipped;selectArrows(t){this.arrows=new Map,this.medal=void 0,t.chunks.forEach(((t,e)=>{const[s,r]=n(e);for(let e=0;e<i;++e)for(let o=0;o<i;++o){const n=t.getArrow(o,e);n.arrowType>0&&this.arrows.set(a(s*i+o,r*i+e),n.copy())}})),this.setRotationState(0,!1)}selectArrow(t){const e=t.copy();e.rotation=0,e.flipped=!1,this.arrows=new Map([[0n,e]]),this.medal=void 0,this.setRotationState(t.rotation,t.flipped)}selectMedal(t){this.arrows=void 0,this.medal=t}clear(){this.arrows=void 0,this.medal=void 0}setRotationState(t,e){this.rotation=t,this.flipped=e,this.update()}setRotation(t){this.rotation=t,this.update()}setFlipped(t){this.flipped=t,this.update()}flip(){this.setFlipped(!this.flipped)}update(){this.rotatedArrows=new Map,this.arrows.forEach(((t,e)=>{let[s,i]=h(e);const r=t.copy();this.flipped&&(r.flipped=!r.flipped,1!==r.rotation&&3!==r.rotation||(r.rotation=(t.rotation+2)%4),s=-s);let o=s,n=i;1===this.rotation?(o=i,n=-s,r.rotation=(r.rotation+1)%4):2===this.rotation?(o=-s,n=-i,r.rotation=(r.rotation+2)%4):3===this.rotation&&(o=-i,n=s,r.rotation=(r.rotation+3)%4),this.rotatedArrows.set(a(o,n),r)}))}}class m{tasks=new Map;running=!1;interval;paused=!1;tick=0;lastUpdate;updateTime;updates;idleTime;nextUpdate;tickCallback;frameCallback;afterFrameCallback;constructor(t,e,s,i){this.tickCallback=e,this.frameCallback=s,this.afterFrameCallback=i,this.setTickRate(t)}updateTick(){const t=performance.now();this.tickCallback?.(),this.updateTime+=performance.now()-t;const e=this.tasks.get(this.tick);if(e)for(const t of e)t();++this.tick,++this.updates}updateFrame(){let t=performance.now();const e=1e3/(t-this.lastUpdate);this.lastUpdate=t,this.idleTime=0;{const e=t;this.frameCallback?.(),this.idleTime+=performance.now()-e}if(!this.paused)for(;(t=performance.now())>=this.nextUpdate;)this.updateTick(),this.nextUpdate+=Math.max(this.interval,this.updateTime/this.updates+e*(this.idleTime+10)/(1e3*this.updates/this.updateTime));{const e=t;this.afterFrameCallback?.(),this.idleTime+=performance.now()-e}}update(){this.updateFrame(),this.running&&requestAnimationFrame((()=>this.update()))}reset(){const t=performance.now();this.lastUpdate=t,this.nextUpdate=t+this.interval,this.updateTime=0,this.updates=0,this.idleTime=0}start(){this.running=!0,this.reset(),this.update()}step(){this.updateTick()}setPaused(t){this.paused=t,this.reset()}stop(){this.running=!1}setTickRate(t){this.interval=1e3/t,this.reset()}schedule(t,e){e+=this.tick;let s=this.tasks.get(e);s?s.push(t):this.tasks.set(e,[t])}}function w(t,e,s,r,o,n){e.flipped&&(o=-o),0===e.rotation?(r+=n,s+=o):1===e.rotation?(s+=n,r-=o):2===e.rotation?(r-=n,s-=o):3===e.rotation&&(s-=n,r+=o);let a=t;if(s>=i?r>=i?(a=t.adjacentChunks[3],s-=i,r-=i):r<0?(a=t.adjacentChunks[1],s-=i,r+=i):(a=t.adjacentChunks[2],s-=i):s<0?r<0?(a=t.adjacentChunks[7],s+=i,r+=i):r>=i?(a=t.adjacentChunks[5],s+=i,r-=i):(a=t.adjacentChunks[6],s+=i):r<0?(a=t.adjacentChunks[0],r+=i):r>=i&&(a=t.adjacentChunks[4],r-=i),!a)return;const h=a.getArrow(s,r);h.arrowType>0&&++h.signalCount}function v(t,e,s){const i=t.createShader(s);if(t.shaderSource(i,e),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(i));return i}const T=[0,0,1,0,1,1,0,1],y=[0,1,2,0,2,3];class A{gl;program;positionAttribute;constructor(t){this.gl=t,this.program=function(t,e,s){const i=t.createProgram();if(t.attachShader(i,e),t.attachShader(i,s),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(i));return i}(t,v(t,this.getVertexShader(),t.VERTEX_SHADER),v(t,this.getFragmentShader(),t.FRAGMENT_SHADER)),this.positionAttribute=this.getAttribLocation("a_position")}destroy(){this.gl.deleteProgram(this.program)}use(){this.gl.useProgram(this.program)}getAttribLocation(t){return this.gl.getAttribLocation(this.program,t)}getUniformLocation(t){return this.gl.getUniformLocation(this.program,t)}}const E=t.p+"7c9973c1c30e9a028f50.png",S=t.p+"f9648cd802127ebe871f.png";class b extends A{arrowAtlasUniform;medalAtlasUniform;transformUniform;rotationUniform;backgroundUniform;arrowTypeUniform;medalTypeUniform;alphaUniform;arrowAtlasTexture;medalAtlasTexture;constructor(t){super(t),this.arrowAtlasUniform=this.getUniformLocation("u_arrowAtlas"),this.medalAtlasUniform=this.getUniformLocation("u_medalAtlas"),this.transformUniform=this.getUniformLocation("u_transform"),this.rotationUniform=this.getUniformLocation("u_rotation"),this.backgroundUniform=this.getUniformLocation("u_background"),this.arrowTypeUniform=this.getUniformLocation("u_arrowType"),this.medalTypeUniform=this.getUniformLocation("u_medalType"),this.alphaUniform=this.getUniformLocation("u_alpha"),this.arrowAtlasTexture=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.arrowAtlasTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0]));const e=new Image;e.src=E,e.onload=()=>{t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.arrowAtlasTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.generateMipmap(t.TEXTURE_2D),e.remove()},this.medalAtlasTexture=t.createTexture(),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.medalAtlasTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0]));const s=new Image;s.src=S,s.onload=()=>{t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.medalAtlasTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.generateMipmap(t.TEXTURE_2D),s.remove()}}destroy(){super.destroy(),this.gl.deleteTexture(this.arrowAtlasTexture),this.gl.deleteTexture(this.medalAtlasTexture)}getVertexShader(){return"precision mediump float;\n\nattribute vec2 a_position;\n\nvarying vec2 v_texcoord;\n\nuniform vec4 u_transform;\nuniform vec2 u_rotation;\n\nmat2 rot(float a) {\n    float s = sin(a);\n    float c = cos(a);\n    return mat2(c, -s, s, c);\n}\n\nvoid main() {\n    v_texcoord = vec2(u_rotation.y, 0.0) + ((a_position * 2.0 - 1.0) * rot(u_rotation.x) * 0.5 + 0.5) * vec2(1.0 - u_rotation.y * 2.0, 1.0);\n    gl_Position = vec4((u_transform.xy + a_position) * u_transform.zw * vec2(2.0, -2.0) + vec2(-1.0, 1.0), 0.0, 1.0);\n}"}getFragmentShader(){return"precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform sampler2D u_arrowAtlas;\nuniform sampler2D u_medalAtlas;\nuniform vec4 u_transform;\nuniform vec3 u_background;\nuniform int u_arrowType;\nuniform int u_medalType;\nuniform float u_alpha;\n\nint tileCount = 16;\nfloat tileSize = 1.0 / float(tileCount);\n\nvoid main() {\n    vec2 texOffset = vec2((u_arrowType - 1) - (u_arrowType - 1) / tileCount * tileCount, (u_arrowType - 1) / tileCount) * tileSize;\n    vec4 color = float(u_arrowType > 0) * texture2D(u_arrowAtlas, texOffset + v_texcoord * tileSize);\n    color = mix(color, vec4(u_background, 1.0), 1.0 - color.a);\n    vec2 mtexOffset = vec2((u_medalType - 1) - (u_medalType - 1) / tileCount * tileCount, (u_medalType - 1) / tileCount) * tileSize;\n    float medalAlpha = 1.0 - smoothstep(0.2, 0.22, distance(v_texcoord, vec2(0.5)));\n    vec2 medalUv = (v_texcoord - 0.3) * tileSize * (1.0 / 0.4);\n    vec4 medalTex = texture2D(u_medalAtlas, mtexOffset + medalUv);\n    medalTex.a *= medalAlpha;\n    vec4 medalColor = vec4(0.941, 0.588, 0.196, medalAlpha);\n    medalColor = float(u_medalType > 0) * mix(medalTex, medalColor, 1.0 - medalTex.a);\n    color = mix(medalColor, color, 1.0 - medalColor.a);\n    color.a = u_alpha;\n    gl_FragColor = color;\n}"}}class C extends A{transformUniform;constructor(t){super(t),this.transformUniform=this.getUniformLocation("u_transform")}getVertexShader(){return"precision mediump float;\n\nattribute vec2 a_position;\n\nvarying vec2 v_texcoord;\n\nvoid main() {\n    v_texcoord = vec2(a_position.x, 1.0 - a_position.y);\n    gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);\n}"}getFragmentShader(){return"#extension GL_OES_standard_derivatives : enable\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform vec4 u_transform;\n\nfloat gridThickness = .08;\n\nfloat filterWidth2(vec2 uv) {\n    vec2 dx = dFdx(uv), dy = dFdy(uv);\n    return dot(dx, dx) + dot(dy, dy) + .0001;\n}\n\nfloat gridSmooth(vec2 p) {\n    vec2 q = p;\n    q += .5;\n    q -= floor(q);\n    q = (gridThickness + 1.) * .5 - abs(q - .5);\n    float w = 12. * filterWidth2(p);\n    float s = sqrt(gridThickness);\n    return smoothstep(.5 - w * s, .5 + w, max(q.x, q.y));\n}\n\nvoid main() {\n    vec2 coord = vec2(1.0 - u_transform.x, 1.0 - u_transform.y) + v_texcoord * u_transform.zw;\n\n    gl_FragColor = vec4(0.8, 0.8, 0.8, 1.0) * gridSmooth(coord);\n}"}}class k extends A{transformUniform;colorUniform;borderUniform;constructor(t){super(t),this.transformUniform=this.getUniformLocation("u_transform"),this.colorUniform=this.getUniformLocation("u_color"),this.borderUniform=this.getUniformLocation("u_border")}getVertexShader(){return"precision mediump float;\n\nattribute vec2 a_position;\n\nvarying vec2 v_texcoord;\n\nuniform vec4 u_transform;\n\nvoid main() {\n    v_texcoord = a_position;\n    gl_Position = vec4((u_transform.xy + a_position * u_transform.zw) * vec2(2.0, -2.0) + vec2(-1.0, 1.0), 0.0, 1.0);\n}"}getFragmentShader(){return"precision mediump float;\n\nvarying vec2 v_texcoord;\n\nuniform vec4 u_transform;\nuniform vec3 u_color;\n\nvoid main() {\n    gl_FragColor = vec4(u_color, 0.5);\n}"}}const _=64;class R{gl;positionBuffer;indexBuffer;arrowShader;backgroundShader;rectShader;constructor(t){this.gl=t,this.gl.getExtension("OES_standard_derivatives"),this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(T),this.gl.STATIC_DRAW),this.indexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(y),this.gl.STATIC_DRAW),this.gl.colorMask(!0,!0,!0,!0),this.gl.clearColor(1,1,1,1),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.arrowShader=new b(this.gl),this.backgroundShader=new C(this.gl),this.rectShader=new k(this.gl),this.arrowShader.use(),t.uniform1i(this.arrowShader.arrowAtlasUniform,0),t.uniform1i(this.arrowShader.medalAtlasUniform,1)}destroy(){this.gl.deleteBuffer(this.positionBuffer),this.gl.deleteBuffer(this.indexBuffer),this.arrowShader.destroy(),this.backgroundShader.destroy(),this.rectShader.destroy(),this.gl.getExtension("WEBGL_lose_context")?.loseContext()}resize(){const t=this.gl.canvas;t.width=t.clientWidth,t.height=t.clientHeight,this.gl.viewport(0,0,t.clientWidth,t.clientHeight)}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}drawBackground(t,e){this.backgroundShader.use(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.enableVertexAttribArray(this.backgroundShader.positionAttribute),this.gl.vertexAttribPointer(this.backgroundShader.positionAttribute,2,this.gl.FLOAT,!1,0,0),this.gl.uniform4f(this.backgroundShader.transformUniform,t[0]/e/_,t[1]/e/_,this.gl.canvas.width/e/_,this.gl.canvas.height/e/_),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0),this.gl.disableVertexAttribArray(this.backgroundShader.positionAttribute)}useArrowShader(){this.arrowShader.use(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.enableVertexAttribArray(this.arrowShader.positionAttribute),this.gl.vertexAttribPointer(this.arrowShader.positionAttribute,2,this.gl.FLOAT,!1,0,0)}setArrowAlpha(t){this.gl.uniform1f(this.arrowShader.alphaUniform,t)}drawArrow(t,e,s,i,r,o,n){this.gl.uniform4f(this.arrowShader.transformUniform,t[0]/e,t[1]/e,_*e/this.gl.canvas.width,_*e/this.gl.canvas.height),this.gl.uniform3f(this.arrowShader.backgroundUniform,n[0],n[1],n[2]),this.gl.uniform1i(this.arrowShader.arrowTypeUniform,s),this.gl.uniform1i(this.arrowShader.medalTypeUniform,i),this.gl.uniform2f(this.arrowShader.rotationUniform,r*Math.PI/2,+o),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0)}disableArrowShader(){this.gl.disableVertexAttribArray(this.arrowShader.positionAttribute)}drawRect(t,e,s){this.rectShader.use(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.enableVertexAttribArray(this.rectShader.positionAttribute),this.gl.vertexAttribPointer(this.rectShader.positionAttribute,2,this.gl.FLOAT,!1,0,0),this.gl.uniform4f(this.rectShader.transformUniform,t[0]/this.gl.canvas.width,t[1]/this.gl.canvas.height,e[0]/this.gl.canvas.width,e[1]/this.gl.canvas.height),this.gl.uniform3f(this.rectShader.colorUniform,s[0],s[1],s[2]),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0),this.gl.disableVertexAttribArray(this.rectShader.positionAttribute)}}function x(t,e,...s){const i=document.createElement(t);return i.className=e,i.append(...s),i}class U{element;constructor(t){this.element=x("span","debug-info hidden"),t.appendChild(this.element),this.update(0,0,"N/A")}destroy(){this.element.remove()}update(t,e,s){this.element.innerText=`FPS: ${e.toFixed(1)}\nTPS: ${t.toFixed(1)}\nUpdate system: ${s}`}toggle(){this.element.classList.toggle("hidden")}}class P extends EventTarget{element;constructor(t,e){super(),this.element=x("span","icon"),this.element.style.backgroundImage=`url(${e})`,this.element.addEventListener("click",(()=>this.dispatchEvent(new MouseEvent("click")))),t.appendChild(this.element)}destroy(){this.element.remove()}}const N=[[1,2,3,4,5],[6,7],[8,9,10,11],[12,13],[14]],L=[[1,2,3,4],[5,6]];class I extends EventTarget{element;sectionButtonsContainer;sectionButtons=[];pages=[];pageItems=[];items=[];sectionId=-1;selectedItem=[-1,-1];currentSection=0;currentPage=0;constructor(t){super(),this.element=x("div","toolbar"),this.sectionButtonsContainer=x("div","toolbar-section-buttons"),this.element.append(this.sectionButtonsContainer);const e=x("div","toolbar-arrow toolbar-arrow-left");e.onclick=()=>this.prevPage(),this.element.append(e);const s=x("div","toolbar-pages");this.element.append(s);const i=x("div","toolbar-arrow toolbar-arrow-right");i.onclick=()=>this.nextPage(),this.element.append(i),t.append(this.element);const r=[],o=[];let n=0;for(const t of N){const e=x("div","toolbar-page");e.style.display="none";for(let s=0;s<5;++s){const i=x("div","toolbar-item");if(t[s]){const e=n;new P(i,`sprites/arrow-${t[s]-1}.png`).addEventListener("click",(()=>{this.selectItem(0,e)})),o.push(i),++n}else i.classList.add("toolbar-item-empty");e.append(i)}s.append(e),r.push(e)}this.addSection("arrows",r,o,N);const a=[],h=[];let l=0;for(const t of L){const e=x("div","toolbar-page");e.style.display="none";for(let s=0;s<5;++s){const i=x("div","toolbar-item");if(t[s]){const e=new P(i,`sprites/medal-${t[s]-1}.png`),r=l;e.addEventListener("click",(()=>{this.selectItem(1,r)})),h.push(i),++l}else i.classList.add("toolbar-item-empty");e.append(i)}s.append(e),a.push(e)}this.addSection("medals",a,h,L),this.selectSection(0),this.goToPage(0)}destroy(){this.element.remove()}addSection(t,e,s,i){const r=++this.sectionId,o=x("span",`${t}-section-button toolbar-section-button`);o.onclick=()=>this.selectSection(r),this.sectionButtonsContainer.append(o),this.sectionButtons.push(o),this.pages.push(e),this.items.push(s),this.pageItems.push(i)}selectSection(t){this.sectionButtons[this.currentSection].classList.remove("toolbar-section-button-active"),this.sectionButtons[t].classList.add("toolbar-section-button-active"),this.pages[this.currentSection][this.currentPage].style.display="none",this.pages[t][0].style.display=null,this.currentSection=t,this.currentPage=0}goToPage(t){this.pages[this.currentSection][this.currentPage].style.display="none",this.pages[this.currentSection][t].style.display=null,this.currentPage=t}nextSection(){let t=this.currentSection+1;t>=this.pages.length&&(t=0),this.selectSection(t)}prevPage(){let t=this.currentPage-1;t<0&&(t=this.pages[this.currentSection].length-1),this.goToPage(t)}nextPage(){let t=this.currentPage+1;t>=this.pages[this.currentSection].length&&(t=0),this.goToPage(t)}selectItem(t,e){this.selectedItem[0]!==t||this.selectedItem[1]!==e||-1===t||-1===e?(this.items[this.selectedItem[0]]?.[this.selectedItem[1]].classList.remove("toolbar-item-active"),this.items[t]?.[e].classList.add("toolbar-item-active"),this.selectedItem=[t,e],this.dispatchEvent(new CustomEvent("select",{detail:{section:t,item:e}}))):this.selectItem(-1,-1)}selectItemOnCurrentPage(t){const e=this.pageItems[this.currentSection][this.currentPage][t-1];e&&this.selectItem(this.currentSection,e-1)}clearSelection(){this.selectItem(-1,-1)}}const M=[2,16,64,256,1024,4096,16384,65536];class D extends EventTarget{element;thumb;currentIndex;mouseDown;constructor(t){super(),this.element=x("div","slider"),this.element.style.aspectRatio=`${M.length}`,this.thumb=x("div","slider-thumb"),this.thumb.addEventListener("mousedown",this.onMouseDown),document.addEventListener("mouseup",this.onMouseUp),document.addEventListener("mousemove",this.onMouseMove),this.element.appendChild(this.thumb),t.appendChild(this.element),this.select(0)}destroy(){this.element.remove(),document.removeEventListener("mouseup",this.onMouseUp),document.removeEventListener("mousemove",this.onMouseMove)}get value(){return M[this.currentIndex]}select(t){this.currentIndex=t,this.dispatchEvent(new CustomEvent("select",{detail:{value:this.value}})),this.thumb.style.left=4*t+"vh",this.thumb.innerText=`${this.value}`}onMouseDown=()=>{this.mouseDown=!0};onMouseUp=()=>{this.mouseDown=!1};onMouseMove=t=>{if(!this.mouseDown)return;const e=this.element.getBoundingClientRect();let s=~~((t.clientX-e.left)/(.04*document.body.clientHeight));s<0?s=0:s>M.length-1&&(s=M.length-1),this.select(s)}}class B extends EventTarget{toolbar;slider;debugInfo;constructor(t){super(),this.toolbar=new I(t),this.slider=new D(t),this.debugInfo=new U(t)}destroy(){this.toolbar.destroy(),this.slider.destroy(),this.debugInfo.destroy()}}var z;!function(t){function e(t,e,i){return s(t,e,i,0)}function s(t,e,s,i=1){const r=s+i,o=s>0?new d(e.arrows.slice(0,s),e.type,s):null,n=r<e.size-1?new d(e.arrows.slice(r),0,e.size-r):null;if(t.delete(e),o){if(t.add(o),1===o.targets.length&&0===o.targets[0].type&&1===o.targets[0].sources.length){const[s]=o.targets;t.delete(s),o.resize(o.size+s.size),o.arrows.push(...s.arrows),o.targets.push(...s.targets);for(const t of s.arrows)t.offset+=e.size}for(const t of e.sources)t.targets.splice(t.targets.indexOf(e),1),o.sources.push(t),t.targets.push(o);for(const t of o.arrows)t.node=o}if(n){t.add(n);for(const t of e.targets)t.sources.splice(t.sources.indexOf(e),1),n.targets.push(t),t.sources.push(n);for(const t of n.arrows)t.node=n,t.offset-=r}return[o,n]}t.splitNode=e,t.spliceNode=s,t.insertNode=function(t,s,i,r){if(1===r.length&&0===s.type){const[e]=r;t.delete(e),s.resize(e.size+s.size);for(const t of s.arrows)t.offset+=e.size;s.arrows.unshift(...e.arrows),s.sources.push(...e.sources);for(const t of s.arrows)t.node=s}else for(const t of r)s.sources.push(t),t.targets.push(s);if(1===i.length){const[[r,o]]=i,[,n]=e(t,r,o);if(0===n.type&&0===n.sources.length){t.delete(n);for(const t of n.arrows)t.offset+=s.size;s.resize(s.size+n.size),s.arrows.push(...n.arrows),s.targets.push(...n.targets)}else n.sources.push(s),s.targets.push(n)}else for(const[r,o]of i){const[,i]=e(t,r,o);i.sources.push(s),s.targets.push(i)}t.add(s)},t.updateNode=function(t,e,s){t.delete(e);const i=new d(e.arrows,s,e.size);if(1===e.sources.length&&0===s){const[s]=e.sources;t.delete(s),i.resize(s.size+e.size),i.arrows.unshift(...s.arrows),i.sources.push(...s.sources);for(const t of e.arrows)t.offset+=s.size;for(const t of i.arrows)t.node=e}else for(const t of e.sources)t.targets.splice(t.targets.indexOf(e),1),i.sources.push(t),t.targets.push(i);for(const t of e.targets)t.sources.splice(t.sources.indexOf(e),1),i.targets.push(t),t.sources.push(i);for(const t of e.arrows)t.node=i;return t.add(i),i}}(z||(z={}));let F=0;const O=document.querySelector("#game");new class{gl;render;ui;selection;map;ticker;resizeObserver;tpsMeter;fpsMeter;simplifiedNodes;saveInterval;mousePosition=[0,0];nodes=new Set;nodeArray=[];mouseStartPosition;startOffset;mouseDown;wheelDown;flipState;removeModeTouchedArrows=new Set;pressedKeys=new Set;highlightedArrows=new Set;highlightStartPosition;highlightSize;offset=[0,0];scale=1;pausedWhenHidden=!1;constructor(t,i){this.gl=i,this.render=new R(i),this.ui=new B(t),this.ui.toolbar.addEventListener("select",(t=>{switch(t.detail.section){case 0:this.selection.selectArrow(new s(N.flat()[t.detail.item]));break;case 1:this.selection.selectMedal(L.flat()[t.detail.item]);break;default:this.selection.clear()}})),this.ui.slider.addEventListener("select",(t=>{this.ticker.setTickRate(t.detail.value)})),this.selection=new g,this.map=new l,this.ticker=new m(this.ui.slider.value,this.tickCallback,this.frameCallback,this.afterFrameCallback),this.resizeObserver=new ResizeObserver((()=>this.render.resize())),this.tpsMeter=new e,this.fpsMeter=new e}start(){this.resizeObserver.observe(this.gl.canvas),document.addEventListener("visibilitychange",this.onVisibilityChange),document.addEventListener("mousedown",this.onMouseDown),document.addEventListener("mouseup",this.onMouseUp),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("click",this.onClick),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),document.addEventListener("wheel",this.onWheel),document.addEventListener("copy",this.onCopy),document.addEventListener("paste",this.onPaste),document.addEventListener("cut",this.onCut),this.ticker.start(),this.saveInterval=window.setInterval((()=>this.save()),3e3);const t=location.hash.slice(1);t&&p(this.map,t),this.createNodes(),this.simplifyNodes()}destroy(){this.ui.destroy(),this.resizeObserver.disconnect(),document.removeEventListener("visibilitychange",this.onVisibilityChange),document.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mouseup",this.onMouseUp),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("click",this.onClick),document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("keyup",this.onKeyUp),document.removeEventListener("wheel",this.onWheel),document.removeEventListener("copy",this.onCopy),document.removeEventListener("paste",this.onPaste),document.removeEventListener("cut",this.onCut),this.ticker.stop(),window.clearInterval(this.saveInterval)}save(){const t=new URL(location.href);t.hash=f(this.map),history.pushState(null,"",t)}createNodes(){this.map.chunks.forEach((t=>{for(let e=0;e<i;++e)for(let s=0;s<i;++s)this.createNode(t,s,e)}))}addTargetNode(t,e,s,r,o,n,a){s.flipped&&(n=-n),0===s.rotation?(o+=a,r+=n):1===s.rotation?(r+=a,o-=n):2===s.rotation?(o-=a,r-=n):3===s.rotation&&(r-=a,o+=n);let h=e;if(r>=i?o>=i?(h=e.adjacentChunks[3],r-=i,o-=i):o<0?(h=e.adjacentChunks[1],r-=i,o+=i):(h=e.adjacentChunks[2],r-=i):r<0?o<0?(h=e.adjacentChunks[7],r+=i,o+=i):o>=i?(h=e.adjacentChunks[5],r+=i,o-=i):(h=e.adjacentChunks[6],r+=i):o<0?(h=e.adjacentChunks[0],o+=i):o>=i&&(h=e.adjacentChunks[4],o-=i),!h)return;const l=this.createNode(h,r,o);l&&(t.targets.push(l),l.sources.push(t))}createNode(t,e,s){const i=t.getArrow(e,s);if(0===i.arrowType)return;if(i.originalNode)return i.originalNode;const r=new d([i],i.medalType,1);return i.originalNode=r,i.node=r,i.offset=0,1===i.arrowType?this.addTargetNode(r,t,i,e,s,0,-1):2===i.arrowType?(this.addTargetNode(r,t,i,e,s,-1,0),this.addTargetNode(r,t,i,e,s,1,0)):3===i.arrowType?(this.addTargetNode(r,t,i,e,s,0,-1),this.addTargetNode(r,t,i,e,s,1,0)):4===i.arrowType?(this.addTargetNode(r,t,i,e,s,-1,0),this.addTargetNode(r,t,i,e,s,0,-1),this.addTargetNode(r,t,i,e,s,1,0)):5===i.arrowType?(this.addTargetNode(r,t,i,e,s,-1,0),this.addTargetNode(r,t,i,e,s,1,0),this.addTargetNode(r,t,i,e,s,0,-1),this.addTargetNode(r,t,i,e,s,0,1)):6===i.arrowType?this.addTargetNode(r,t,i,e,s,0,-2):7===i.arrowType?this.addTargetNode(r,t,i,e,s,1,-1):8===i.arrowType?(this.addTargetNode(r,t,i,e,s,0,-1),this.addTargetNode(r,t,i,e,s,1,-1)):9===i.arrowType?(this.addTargetNode(r,t,i,e,s,0,-2),this.addTargetNode(r,t,i,e,s,1,0)):10===i.arrowType?(this.addTargetNode(r,t,i,e,s,-2,0),this.addTargetNode(r,t,i,e,s,1,0)):11===i.arrowType?(this.addTargetNode(r,t,i,e,s,0,-1),this.addTargetNode(r,t,i,e,s,0,-2)):12===i.arrowType?(this.addTargetNode(r,t,i,e,s,0,0),this.addTargetNode(r,t,i,e,s,0,-1)):13===i.arrowType&&(this.addTargetNode(r,t,i,e,s,-1,0),this.addTargetNode(r,t,i,e,s,0,0),this.addTargetNode(r,t,i,e,s,1,0)),r}simplifyNodes(){this.simplifiedNodes=new WeakMap,this.map.chunks.forEach((t=>{for(let e=0;e<i;++e)for(let s=0;s<i;++s){const i=t.getArrow(s,e);i.node&&this.simplifyNode(i.node)}})),delete this.simplifiedNodes,this.nodes.forEach((t=>{for(const e of t.arrows)e.node=t;for(const e of t.targets)e.sources.push(t)})),this.nodeArray=Array.from(this.nodes)}simplifyNode(t){const e=this.simplifiedNodes.get(t);if(e)return e;const s=t.copy();if(this.simplifiedNodes.set(t,s),this.simplifiedNodes.set(s,s),this.nodes.add(s),1===t.targets.length){const[e]=t.targets,i=this.simplifyNode(e);if(0===e.type&&1===e.sources.length&&i.ready){this.nodes.delete(i),s.resize(t.size+i.size),s.arrows.push(...i.arrows),s.targets.push(...i.targets);for(const e of i.arrows)e.offset+=t.size}else s.targets.push(i)}else for(const e of t.targets)s.targets.push(this.simplifyNode(e));return s.ready=!0,s}getArrowRelative(t,e,s,r,o,n){e.flipped&&(o=-o),0===e.rotation?(r+=n,s+=o):1===e.rotation?(s+=n,r-=o):2===e.rotation?(r-=n,s-=o):3===e.rotation&&(s-=n,r+=o);let a=t;if(s>=i?r>=i?(a=t.adjacentChunks[3],s-=i,r-=i):r<0?(a=t.adjacentChunks[1],s-=i,r+=i):(a=t.adjacentChunks[2],s-=i):s<0?r<0?(a=t.adjacentChunks[7],s+=i,r+=i):r>=i?(a=t.adjacentChunks[5],s+=i,r-=i):(a=t.adjacentChunks[6],s+=i):r<0?(a=t.adjacentChunks[0],r+=i):r>=i&&(a=t.adjacentChunks[4],r-=i),!a)return;const h=a.getArrow(s,r);return h.arrowType>0?[a,h,[s,r]]:void 0}getTargetArrows(t,e,s,i){const r=[];return 1===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,0,-1)?.[1]):2===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,-1,0)?.[1],this.getArrowRelative(t,e,s,i,1,0)?.[1]):3===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,0,-1)?.[1],this.getArrowRelative(t,e,s,i,1,0)?.[1]):4===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,-1,0)?.[1],this.getArrowRelative(t,e,s,i,0,-1)?.[1],this.getArrowRelative(t,e,s,i,1,0)?.[1]):5===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,-1,0)?.[1],this.getArrowRelative(t,e,s,i,1,0)?.[1],this.getArrowRelative(t,e,s,i,0,-1)?.[1],this.getArrowRelative(t,e,s,i,0,1)?.[1]):6===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,0,-2)?.[1]):7===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,1,-1)?.[1]):8===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,0,-1)?.[1],this.getArrowRelative(t,e,s,i,1,-1)?.[1]):9===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,0,-2)?.[1],this.getArrowRelative(t,e,s,i,1,0)?.[1]):10===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,-2,0)?.[1],this.getArrowRelative(t,e,s,i,1,0)?.[1]):11===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,0,-1)?.[1],this.getArrowRelative(t,e,s,i,0,-2)?.[1]):12===e.arrowType?r.push(this.getArrowRelative(t,e,s,i,0,0)?.[1],this.getArrowRelative(t,e,s,i,0,-1)?.[1]):13===e.arrowType&&r.push(this.getArrowRelative(t,e,s,i,-1,0)?.[1],this.getArrowRelative(t,e,s,i,0,0)?.[1],this.getArrowRelative(t,e,s,i,1,0)?.[1]),r.filter((t=>t))}getSourceArrows(t,e,s,i){return[[t,e,[s,i]],this.getArrowRelative(t,e,s,i,-1,0),this.getArrowRelative(t,e,s,i,1,0),this.getArrowRelative(t,e,s,i,0,1),this.getArrowRelative(t,e,s,i,0,-1),this.getArrowRelative(t,e,s,i,-2,0),this.getArrowRelative(t,e,s,i,2,0),this.getArrowRelative(t,e,s,i,0,2),this.getArrowRelative(t,e,s,i,0,-2),this.getArrowRelative(t,e,s,i,-1,1),this.getArrowRelative(t,e,s,i,1,1),this.getArrowRelative(t,e,s,i,-1,-1),this.getArrowRelative(t,e,s,i,1,-1)].filter((t=>t)).filter((([t,s,[i,r]])=>this.getTargetArrows(t,s,i,r).includes(e))).map((([,t])=>t))}tickCallback=()=>{this.update(),this.tpsMeter.step()};frameCallback=()=>{this.updatePlayerInput(),this.tpsMeter.update(),this.fpsMeter.update()};afterFrameCallback=()=>{let t;this.draw(),this.fpsMeter.step(),t=0===F?"CA":"Nodes",this.ui.debugInfo.update(this.tpsMeter.value,this.fpsMeter.value,t)};update(){0===F?this.updateCA():this.updateNodes()}updateCA(){this.map.chunks.forEach((t=>{for(let e=0;e<i;++e)for(let s=0;s<i;++s){const i=t.getArrow(s,e);i.arrowType>0&&i.active&&(1===i.arrowType?w(t,i,s,e,0,-1):2===i.arrowType?(w(t,i,s,e,-1,0),w(t,i,s,e,1,0)):3===i.arrowType?(w(t,i,s,e,0,-1),w(t,i,s,e,1,0)):4===i.arrowType?(w(t,i,s,e,-1,0),w(t,i,s,e,0,-1),w(t,i,s,e,1,0)):5===i.arrowType?(w(t,i,s,e,-1,0),w(t,i,s,e,1,0),w(t,i,s,e,0,-1),w(t,i,s,e,0,1)):6===i.arrowType?w(t,i,s,e,0,-2):7===i.arrowType?w(t,i,s,e,1,-1):8===i.arrowType?(w(t,i,s,e,0,-1),w(t,i,s,e,1,-1)):9===i.arrowType?(w(t,i,s,e,0,-2),w(t,i,s,e,1,0)):10===i.arrowType?(w(t,i,s,e,-2,0),w(t,i,s,e,1,0)):11===i.arrowType?(w(t,i,s,e,0,-1),w(t,i,s,e,0,-2)):12===i.arrowType?(w(t,i,s,e,0,0),w(t,i,s,e,0,-1)):13===i.arrowType&&(w(t,i,s,e,-1,0),w(t,i,s,e,0,0),w(t,i,s,e,1,0)))}})),this.map.chunks.forEach((t=>{for(let e=0;e<i;++e)for(let s=0;s<i;++s){const i=t.getArrow(s,e);i.arrowType>0&&(0===i.medalType?i.active=i.signalCount>0:1===i.medalType?i.active=!0:2===i.medalType?i.active=0===i.signalCount:3===i.medalType?i.active=i.signalCount>=2:4===i.medalType?i.active=i.signalCount%2==1:5===i.medalType?i.signalCount>0&&(i.active=!i.active):6===i.medalType&&i.signalCount>0&&(i.active=i.signalCount%2==0),i.lastState=i.copyState(),i.signalCount=0)}}))}updateNodes(){this.nodeArray.forEach((t=>{if(t.lastSignal=t.signals.at(0),t.signals.at(-1))for(const e of t.targets)e&&++e.signalCount})),this.nodeArray.forEach((t=>{let e=t.lastSignal;switch(t.type){case 0:e=t.signalCount>0;break;case 1:e=!0;break;case 2:e=0===t.signalCount;break;case 3:e=t.signalCount>=2;break;case 4:e=t.signalCount%2==1;break;case 5:t.signalCount>0&&(e=!e);break;case 6:t.signalCount>0&&(e=t.signalCount%2==0)}t.signals.insert(e),t.lastSignalCount=t.signalCount,t.signalCount=0}))}updatePlayerInput(){const[t,e]=this.screenToWorld(...this.mousePosition),s=this.map.getArrow(t,e);if(this.mouseDown)if(this.selection.arrows)this.selection.rotatedArrows.forEach(((s,r)=>{const[o,n]=h(r),a=t+o,l=e+n,c=this.map.getOrCreateArrow(a,l),u=+(a<0),f=+(l<0),p=~~((a+u)/16)-u,g=~~((l+f)/16)-f,m=this.map.getChunk(p,g);c.arrowType>0&&z.spliceNode(this.nodes,c.node,c.offset),c.merge(s);const w=new d([c],c.medalType,1);c.node=w,c.offset=0;const v=this.getTargetArrows(m,c,a-p*i,l-g*i).map((t=>[t.node,t.offset])),T=this.getSourceArrows(m,c,a-p*i,l-g*i).map((t=>t.node));z.insertNode(this.nodes,w,v,T)})),this.nodeArray=Array.from(this.nodes);else if(this.selection.medal&&s&&s.arrowType>0){s.medalType=this.selection.medal;const[,t]=z.splitNode(this.nodes,s.node,s.offset);z.updateNode(this.nodes,t,this.selection.medal),this.nodeArray=Array.from(this.nodes)}if(s&&s.arrowType>0&&(this.selection.arrows||(this.isKeyPressed("KeyW")?s.rotation=0:this.isKeyPressed("KeyA")?s.rotation=1:this.isKeyPressed("KeyS")?s.rotation=2:this.isKeyPressed("KeyD")?s.rotation=3:this.isKeyPressed("KeyF")?void 0===this.flipState?s.flipped=this.flipState=!s.flipped:s.flipped=this.flipState:this.flipState=void 0),this.isKeyPressed("KeyR")?this.removeModeTouchedArrows.has(s)||(0!==s.medalType?(s.medalType=0,z.updateNode(this.nodes,s.node,0),this.nodeArray=Array.from(this.nodes)):(this.map.removeArrow(t,e),z.spliceNode(this.nodes,s.node,s.offset),this.nodeArray=Array.from(this.nodes)),this.removeModeTouchedArrows.add(s)):this.removeModeTouchedArrows.clear()),this.isKeyPressed("KeyE")){if(!this.highlightStartPosition){const t=this.mousePosition[0]-this.offset[0],e=this.mousePosition[1]-this.offset[1];this.highlightStartPosition=[t,e],this.highlightSize=[0,0]}}else this.highlightStartPosition=void 0,this.highlightSize=void 0}draw(){this.render.clear(),this.render.useArrowShader(),this.render.setArrowAlpha(1);const t=~~(-this.offset[0]/this.scale/_/i)-1,e=~~(-this.offset[1]/this.scale/_/i)-1,s=~~(-this.offset[0]/this.scale/_/i+this.gl.canvas.width/this.scale/i),r=~~(-this.offset[1]/this.scale/_/i+this.gl.canvas.height/this.scale/i);this.map.chunks.forEach(((o,a)=>{const[h,l]=n(a);if(!(h>=t&&h<=s&&l>=e&&l<=r))return;const c=this.offset[0]/_,d=this.offset[1]/_;for(let t=0;t<i;++t)for(let e=0;e<i;++e){const s=o.getArrow(e,t);if(s.arrowType>0){const r=(h*i+e)*this.scale+c,o=(l*i+t)*this.scale+d;let n;n=0===F?s.active?[1,0,0]:s.lastState.signalCount>0?[.3,.5,1]:[1,1,1]:s.node.signals.at(s.offset)?[1,0,0]:0===s.offset&&s.node.lastSignalCount>0?[.3,.5,1]:[1,1,1],this.render.drawArrow([r,o],this.scale,s.arrowType,s.medalType,s.rotation,s.flipped,n)}}})),this.render.setArrowAlpha(.5);const[o,a]=this.screenToWorld(...this.mousePosition);if(this.selection.arrows){const t=~~(-this.offset[0]/_+this.gl.canvas.width/this.scale),e=~~(-this.offset[1]/_+this.gl.canvas.height/this.scale);this.selection.rotatedArrows.forEach(((s,i)=>{const[r,n]=h(i);o+r<=t&&a+n<=e&&this.render.drawArrow([this.offset[0]/_+o*this.scale+r*this.scale,this.offset[1]/_+a*this.scale+n*this.scale],this.scale,s.arrowType,s.medalType,s.rotation,s.flipped,[1,1,1])}))}else this.selection.medal&&this.render.drawArrow([this.offset[0]/_+o*this.scale,this.offset[1]/_+a*this.scale],this.scale,0,this.selection.medal,0,!1,[1,1,1]);this.render.disableArrowShader();for(const t of this.highlightedArrows){const[e,s]=h(t);this.render.drawRect([e*_*this.scale+this.offset[0],s*_*this.scale+this.offset[1]],[_*this.scale,_*this.scale],[.98,.784,.282])}this.render.drawBackground(this.offset,this.scale),this.highlightStartPosition&&this.highlightSize&&this.render.drawRect([this.highlightStartPosition[0]+this.offset[0],this.highlightStartPosition[1]+this.offset[1]],this.highlightSize,[.996,.957,.855])}exportGraph(){const t=["|","1","!","&","^","0/1","F"];let e="digraph {\n";this.nodeArray.forEach(((s,i)=>{let r=t[s.type];s.arrows.forEach(((t,e)=>console.assert(t.offset===e,t))),0===s.targets.length&&(r+=` (${s.size})`),e+=`  node${i} [label=${JSON.stringify(r)}]\n`;for(const t of s.targets)e+=`  node${i} -> node${this.nodeArray.indexOf(t)} [minlen=${s.size}, label=${s.size}]\n`})),e+="}",console.log(`https://dreampuf.github.io/GraphvizOnline/#${encodeURIComponent(e)}`)}setScale(t,e){t<.05&&(t=.05),t>2&&(t=2),this.offset=[this.offset[0]/this.scale*t+e[0]-e[0]/this.scale*t,this.offset[1]/this.scale*t+e[1]-e[1]/this.scale*t],this.startOffset&&(this.startOffset=this.startOffset),this.scale=t}screenToWorld(t,e){const s=(t-this.offset[0])/this.scale/_,i=(e-this.offset[1])/this.scale/_;return[~~s-+(s<0),~~i-+(i<0)]}isKeyPressed(t){return this.pressedKeys.has(t)}isShiftPressed(){return this.isKeyPressed("ShiftLeft")||this.isKeyPressed("ShiftRight")}isCtrlPressed(){return this.isKeyPressed("ControlLeft")||this.isKeyPressed("ControlRight")}onVisibilityChange=()=>{document.hidden?(this.pausedWhenHidden=this.ticker.paused,this.ticker.setPaused(!0)):this.ticker.setPaused(this.pausedWhenHidden)};onMouseDown=t=>{t.target===this.gl.canvas&&(t.preventDefault(),0===t.button?this.mouseDown=!0:1===t.button&&(this.mouseStartPosition=[t.clientX,t.clientY],this.startOffset=this.offset,this.wheelDown=!0))};onMouseUp=t=>{0===t.button?this.mouseDown=!1:1===t.button&&(this.wheelDown=!1)};onMouseMove=t=>{if(this.mousePosition=[t.clientX,t.clientY],this.wheelDown&&(this.offset=[this.startOffset[0]+t.clientX-this.mouseStartPosition[0],this.startOffset[1]+t.clientY-this.mouseStartPosition[1]]),this.isKeyPressed("KeyE")&&this.highlightStartPosition){const t=this.mousePosition[0]-this.offset[0],e=this.mousePosition[1]-this.offset[1];this.highlightSize=[t-this.highlightStartPosition[0],e-this.highlightStartPosition[1]];const s=this.isShiftPressed(),i=this.isCtrlPressed();s||i||this.highlightedArrows.clear();const[r,o]=this.screenToWorld(this.highlightStartPosition[0]+this.offset[0],this.highlightStartPosition[1]+this.offset[1]),[n,h]=this.screenToWorld(...this.mousePosition),l=Math.min(r,n),c=Math.min(o,h),d=Math.max(r,n),u=Math.max(o,h);for(let t=c;t<=u;++t)for(let e=l;e<=d;++e){const s=this.map.getArrow(e,t);if(s&&s.arrowType>0){const s=a(e,t);i?this.highlightedArrows.delete(s):this.highlightedArrows.add(s)}}}};onKeyDown=t=>{this.pressedKeys.add(t.code);const[e,s]=this.screenToWorld(...this.mousePosition),r=this.map.getArrow(e,s);if(/^Digit[0-9]$/.test(t.code))this.ui.toolbar.selectItemOnCurrentPage(+t.code.at(-1));else if("Tab"===t.code)this.ui.toolbar.nextSection();else if("F3"===t.code)this.ui.debugInfo.toggle();else if("F5"===t.code)F=(F+1)%2,this.ticker.setPaused(!1);else if("F6"===t.code)this.exportGraph();else if("Backquote"===t.code)this.ui.toolbar.clearSelection();else if("KeyN"===t.code)this.map.chunks.forEach((t=>{for(let e=0;e<i;++e)for(let s=0;s<i;++s){const i=t.getArrow(s,e);i.signalCount=0,i.active=!1,i.lastState=i.copyState()}}));else if("Backspace"===t.code){if(this.highlightedArrows.size>0){for(const t of this.highlightedArrows){const[e,s]=h(t),i=this.map.getArrow(e,s);this.map.removeArrow(e,s),z.spliceNode(this.nodes,i.node,i.offset)}this.nodeArray=Array.from(this.nodes),this.highlightedArrows.clear()}}else if("Space"===t.code)this.ticker.setPaused(!this.ticker.paused);else if("Enter"===t.code)this.ticker.paused&&this.ticker.step();else if("KeyW"===t.code)this.selection.arrows&&this.selection.setRotation(0);else if("KeyA"===t.code)this.selection.arrows&&this.selection.setRotation(1);else if("KeyS"===t.code)this.selection.arrows&&this.selection.setRotation(2);else if("KeyD"===t.code)this.selection.arrows&&this.selection.setRotation(3);else if("KeyF"===t.code)this.selection.arrows&&this.selection.flip();else if("KeyQ"===t.code)r&&0!==r.arrowType&&(this.ui.toolbar.selectItem(0,r.arrowType-1),this.selection.selectArrow(r));else if("KeyE"!==t.code)return;t.preventDefault()};onKeyUp=t=>{this.pressedKeys.delete(t.code)};onClick=t=>{if(t.target!==this.gl.canvas)return;if(this.selection.arrows||this.selection.medal)return;const[e,s]=this.screenToWorld(t.clientX,t.clientY),i=this.map.getArrow(e,s);i&&0!==i.arrowType&&(0===F?i.active=!i.active:i.node.signals.set(i.offset,!i.node.signals.at(i.offset)))};onWheel=t=>{t.target===this.gl.canvas&&(t.deltaY>0?this.setScale(this.scale/1.2,[t.clientX,t.clientY]):t.deltaY<0&&this.setScale(1.2*this.scale,[t.clientX,t.clientY]))};copy(t){const e=new l;let s=1/0,i=1/0;for(const t of this.highlightedArrows){const[e,r]=h(t);e<s&&(s=e),r<i&&(i=r)}for(const t of this.highlightedArrows){const[r,o]=h(t);e.getOrCreateArrow(r-s,o-i).merge(this.map.getArrow(r,o))}t.setData("text/plain",f(e))}onCopy=t=>{this.highlightedArrows.size>0&&(t.preventDefault(),this.copy(t.clipboardData),this.highlightedArrows.clear())};onPaste=t=>{const e=t.clipboardData.getData("text/plain");if(!e)return;const s=new l;try{p(s,e)}catch{return}t.preventDefault(),this.ui.toolbar.clearSelection(),this.selection.selectArrows(s)};onCut=t=>{if(this.highlightedArrows.size>0){t.preventDefault(),this.copy(t.clipboardData);for(const t of this.highlightedArrows){const[e,s]=h(t),i=this.map.getArrow(e,s);this.map.removeArrow(e,s),z.spliceNode(this.nodes,i.node,i.offset)}this.nodeArray=Array.from(this.nodes),this.highlightedArrows.clear()}}}(document.body,O.getContext("webgl",{premultipliedAlpha:!1})).start()})();